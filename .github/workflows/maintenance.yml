name: ğŸ”§ Repository Maintenance

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  workflow_dispatch:
    inputs:
      maintenance_type:
        description: 'Type of maintenance to run'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - cleanup-only
          - update-deps
          - security-audit

permissions:
  contents: write
  pull-requests: write
  issues: write
  security-events: write

env:
  GO_VERSION: '1.23.4'

jobs:
  # Dependency updates
  dependency-updates:
    name: ğŸ“¦ Update Dependencies
    runs-on: ubuntu-latest
    if: github.event.inputs.maintenance_type != 'cleanup-only'
    
    steps:
      - name: ğŸ“‹ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: ğŸ“¦ Update Go dependencies
        run: |
          echo "ğŸ“¦ Updating Go dependencies..."
          if [ -f "go.mod" ]; then
            go get -u ./...
            go mod tidy
            echo "âœ… Go dependencies updated"
          else
            echo "â„¹ï¸ No go.mod found, skipping Go dependency updates"
          fi
      
      - name: ğŸ” Check for dependency changes
        id: changes
        run: |
          if git diff --quiet go.mod go.sum 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No dependency changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Dependency changes detected"
          fi
      
      - name: ğŸ“¤ Commit dependency updates
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'Dependency Bot'
          git config --global user.email 'deps-bot@users.noreply.github.com'
          
          git add go.mod go.sum
          git commit -m "ğŸ“¦ Update Go dependencies

          - Updated to latest compatible versions
          - Automated security and compatibility updates
          - Run go mod tidy for cleanup
          
          ğŸ¤– Auto-generated by maintenance workflow"
          
          git push origin main
          echo "âœ… Dependency updates committed and pushed"

  # Code cleanup and formatting
  code-cleanup:
    name: ğŸ§¹ Code Cleanup
    runs-on: ubuntu-latest
    needs: dependency-updates
    if: always() && github.event.inputs.maintenance_type != 'update-deps'
    
    steps:
      - name: ğŸ“‹ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main  # Get latest changes from dependency updates
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: ğŸ¨ Format Go code
        run: |
          echo "ğŸ¨ Formatting Go code..."
          if [ -f "main.go" ]; then
            go fmt ./...
            echo "âœ… Go code formatted"
          else
            echo "â„¹ï¸ No Go files found, skipping formatting"
          fi
      
      - name: ğŸ” Run go vet
        run: |
          echo "ğŸ” Running go vet..."
          if [ -f "go.mod" ]; then
            go vet ./...
            echo "âœ… go vet passed"
          else
            echo "â„¹ï¸ No go.mod found, skipping go vet"
          fi
      
      - name: ğŸ§¹ Clean up old artifacts
        run: |
          echo "ğŸ§¹ Cleaning up old artifacts..."
          
          # Remove any temporary files
          find . -name "*.tmp" -type f -delete
          find . -name "*.log" -type f -delete
          find . -name ".DS_Store" -type f -delete
          
          # Clean up old backup files
          find . -name "*.backup" -type f -mtime +7 -delete
          find . -name "*.bak" -type f -mtime +7 -delete
          
          echo "âœ… Cleanup completed"
      
      - name: ğŸ“ Update documentation timestamps
        run: |
          echo "ğŸ“ Updating documentation..."
          
          # Update any documentation with current date
          if [ -f "docs/README.md" ]; then
            sed -i "s/Last updated: .*/Last updated: $(date -u +'%Y-%m-%d')/" docs/README.md
          fi
          
          echo "âœ… Documentation updated"
      
      - name: ğŸ” Check for cleanup changes
        id: cleanup_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No cleanup changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Cleanup changes detected"
          fi
      
      - name: ğŸ“¤ Commit cleanup changes
        if: steps.cleanup_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'Cleanup Bot'
          git config --global user.email 'cleanup-bot@users.noreply.github.com'
          
          git add -A
          git commit -m "ğŸ§¹ Automated code cleanup and maintenance

          - Format Go code with go fmt
          - Run go vet for code quality
          - Clean up temporary and old files
          - Update documentation timestamps
          
          ğŸ¤– Auto-generated by maintenance workflow"
          
          git push origin main
          echo "âœ… Cleanup changes committed and pushed"

  # Security audit
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: [dependency-updates, code-cleanup]
    if: always() && github.event.inputs.maintenance_type != 'cleanup-only'
    
    steps:
      - name: ğŸ“‹ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: ğŸ”’ Run security audit
        run: |
          echo "ğŸ”’ Running security audit..."
          
          # Install govulncheck if not already installed
          go install golang.org/x/vuln/cmd/govulncheck@latest
          
          # Run vulnerability check
          if [ -f "go.mod" ]; then
            govulncheck ./... || echo "âš ï¸ Vulnerabilities detected - check logs"
          fi
          
          echo "âœ… Security audit completed"
      
      - name: ğŸ” Check for security issues
        run: |
          echo "ğŸ” Checking for common security issues..."
          
          # Check for hardcoded secrets (basic patterns)
          echo "Checking for potential secrets..."
          if grep -r -i -E "(password|secret|key|token).*=" . --exclude-dir=.git --exclude="*.yml" --exclude="*.yaml" || true; then
            echo "âš ï¸ Potential secrets detected - manual review recommended"
          fi
          
          # Check file permissions
          echo "Checking file permissions..."
          find . -type f -perm /002 -not -path "./.git/*" | head -10 || true
          
          echo "âœ… Security checks completed"

  # Repository health check
  health-check:
    name: ğŸ¥ Repository Health Check
    runs-on: ubuntu-latest
    needs: [dependency-updates, code-cleanup, security-audit]
    if: always()
    
    steps:
      - name: ğŸ“‹ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: ğŸ“Š Repository statistics
        run: |
          echo "ğŸ“Š Repository Health Report"
          echo "=========================="
          echo "ğŸ—“ï¸ Date: $(date -u)"
          echo "ğŸ“ Files: $(find . -type f -not -path "./.git/*" | wc -l)"
          echo "ğŸ“ Go files: $(find . -name "*.go" -not -path "./.git/*" | wc -l)"
          echo "ğŸ”§ Workflows: $(find .github/workflows -name "*.yml" -o -name "*.yaml" | wc -l)"
          echo "ğŸ“„ Docs: $(find . -name "*.md" -not -path "./.git/*" | wc -l)"
          echo ""
          
          # Check README status
          if [ -f "README.md" ]; then
            echo "âœ… README.md present"
            echo "ğŸ“ README size: $(wc -l < README.md) lines"
          else
            echo "âŒ README.md missing"
          fi
          
          # Check main.go status
          if [ -f "main.go" ]; then
            echo "âœ… main.go present"
            echo "ğŸ“ Main file size: $(wc -l < main.go) lines"
          else
            echo "âŒ main.go missing"
          fi
          
          # Check workflows
          if [ -d ".github/workflows" ]; then
            echo "âœ… GitHub workflows configured"
            echo "ğŸ”§ Workflow files: $(ls -1 .github/workflows/*.yml 2>/dev/null | wc -l)"
          else
            echo "âŒ No GitHub workflows found"
          fi
      
      - name: ğŸ” Build test
        run: |
          echo "ğŸ” Testing build process..."
          if [ -f "main.go" ] && [ -f "go.mod" ]; then
            echo "ğŸ—ï¸ Building application..."
            go build -v ./...
            echo "âœ… Build successful"
          else
            echo "â„¹ï¸ Go project not detected, skipping build test"
          fi
      
      - name: ğŸ“ Generate health report
        run: |
          echo "ğŸ“ Generating health report..."
          
          cat > MAINTENANCE_REPORT.md << 'EOF'
          # ğŸ¥ Repository Maintenance Report
          
          **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Workflow Run**: ${{ github.run_number }}
          
          ## ğŸ“Š Health Summary
          
          | Component | Status | Details |
          |-----------|--------|---------|
          | Dependencies | ${{ needs.dependency-updates.result == 'success' && 'âœ… Updated' || 'âš ï¸ Check required' }} | Go modules and security updates |
          | Code Quality | ${{ needs.code-cleanup.result == 'success' && 'âœ… Clean' || 'âš ï¸ Issues found' }} | Formatting and cleanup |
          | Security | ${{ needs.security-audit.result == 'success' && 'âœ… Secure' || 'âš ï¸ Review needed' }} | Vulnerability scan |
          | Build | âœ… Passing | Compilation test successful |
          
          ## ğŸ”§ Actions Taken
          
          - ğŸ“¦ Dependency updates: ${{ needs.dependency-updates.result }}
          - ğŸ§¹ Code cleanup: ${{ needs.code-cleanup.result }}
          - ğŸ”’ Security audit: ${{ needs.security-audit.result }}
          
          ## ğŸ“ˆ Next Maintenance
          
          Next scheduled maintenance: **Next Monday 2 AM UTC**
          
          ---
          *Generated by automated maintenance workflow*
          EOF
          
          echo "âœ… Health report generated"
      
      - name: ğŸ“‹ Create summary
        run: |
          echo "# ğŸ”§ Maintenance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependencies**: ${{ needs.dependency-updates.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Cleanup**: ${{ needs.code-cleanup.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Audit**: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â° Schedule" >> $GITHUB_STEP_SUMMARY
          echo "- **Next Run**: Weekly on Monday at 2 AM UTC" >> $GITHUB_STEP_SUMMARY
          echo "- **Manual Trigger**: Available via workflow_dispatch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¤– Automated maintenance workflow completed successfully!"